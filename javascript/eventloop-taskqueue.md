# ì´ë²¤íŠ¸ ë£¨í”„ì™€ íƒœìŠ¤í¬ í \(ë§ˆì´í¬ë¡œ íƒœìŠ¤í¬, ë§¤í¬ë¡œ íƒœìŠ¤í¬\)

ìë°”ìŠ¤í¬ë¦½íŠ¸ëŠ” **ì‹±ê¸€ ìŠ¤ë ˆë“œ ê¸°ë°˜ì˜ ì–¸ì–´**ì´ê³ , ìë°”ìŠ¤í¬ë¦½íŠ¸ ì—”ì§„ì€ **í•˜ë‚˜ì˜ í˜¸ì¶œ ìŠ¤íƒë§Œì„ ì‚¬ìš©**í•œë‹¤. ì´ëŠ” ìš”ì²­ì´ **ë™ê¸°ì **ìœ¼ë¡œ ì²˜ë¦¬ë˜ì–´, **í•œ ë²ˆì— í•œ ê°€ì§€ ì¼ë§Œ ì²˜ë¦¬í•  ìˆ˜ ìˆìŒ**ì„ ì˜ë¯¸í•œë‹¤.

ë§Œì•½, ë„¤íŠ¸ì›Œí¬ ìš”ì²­ê³¼ ê°™ì€ ë¹„ë™ê¸° í•¨ìˆ˜ê°€ ë™ê¸°ì ìœ¼ë¡œ ì´ë£¨ì–´ì§€ëŠ” í•¨ìˆ˜ë¡œ ë§Œë“¤ì–´ì¡Œë‹¤ë©´, ì–´ë–¤ ì¼ì´ ì¼ì–´ë‚ ê¹Œ?

ë„¤íŠ¸ì›Œí¬ ìš”ì²­ì´ ë‹¤ë¥¸ ì„œë²„ë¡œ ë³´ë‚´ì§€ê³ , ì»´í“¨í„°ëŠ” ì‘ë‹µ ë°›ê¸°ë¥¼ ê¸°ë‹¤ë¦¬ë©° ëŠë ¤ì§ˆ ê²ƒì´ë‹¤. ê·¸ ì‚¬ì´ì— í´ë¦­ì´ë‚˜, ë‹¤ë¥¸ ìš”ì†Œê°€ ë Œë”ë§ì´ ë˜ì–´ì ¸ì•¼ í•˜ëŠ”ê²Œ ìˆë”ë¼ë„, ìŠ¤íƒì€ ë„¤íŠ¸ì›Œí¬ ìš”ì²­ í•¨ìˆ˜ì— ë¸”ë½í‚¹ ë˜ì–´ìˆìœ¼ë¯€ë¡œ, ì•„ë¬´ ì¼ë„ ì¼ì–´ë‚˜ì§€ ì•Šê²Œ ëœë‹¤.

ì´ëŸ¬í•œ ë¬¸ì œëŠ” **ë¹„ë™ê¸° ì½œë°±**ì„ ì‚¬ìš©í•¨ìœ¼ë¡œì¨ í•´ê²°ëœë‹¤. ë¹„ë™ê¸° ìš”ì²­ì€ ìë°”ìŠ¤í¬ë¦½íŠ¸ ì—”ì§„ì„ êµ¬ë™í•˜ëŠ” í™˜ê²½ì¸ ë¸Œë¼ìš°ì €ë‚˜ Node.jsì—ì„œ ì²˜ë¦¬ëœë‹¤.

## ğŸ“• ë¹„ë™ê¸° ì²˜ë¦¬ë¥¼ ìœ„í•œ ë¸Œë¼ìš°ì €ì™€ Node.jsì˜ êµ¬ì¡°

### ğŸ“ ë¸Œë¼ìš°ì € í™˜ê²½ì˜ êµ¬ì¡°

![](https://i.imgur.com/1oCFAbj.png)

* **ìë°”ìŠ¤í¬ë¦½íŠ¸ ì—”ì§„**
  * **Heap** : ê°ì²´ë“¤ì€ í™ ë©”ëª¨ë¦¬ì— í• ë‹¹ëœë‹¤. í¬ê¸°ê°€ ë™ì ìœ¼ë¡œ ë³€í•˜ëŠ” ê°’ë“¤ì˜ ì°¸ì¡° ê°’ì„ ê°–ê³  ìˆë‹¤. 
  * **Call Stack** : í•¨ìˆ˜ í˜¸ì¶œ ì‹œ, ì‹¤í–‰ ì»¨í…ìŠ¤íŠ¸ê°€ ìƒì„±ë˜ë©°, ì´ëŸ¬í•œ ì‹¤í–‰ ì»¨í…ìŠ¤íŠ¸ë“¤ì´ ì½œ ìŠ¤íƒì„ êµ¬ì„±í•œë‹¤.
* **Web API or Browser API**
  * ì›¹ ë¸Œë¼ìš°ì €ì— êµ¬í˜„ëœ APIì´ë‹¤. 
  * DOM event, AJAX, Timer ë“±ì´ ìˆë‹¤. 
* **ì´ë²¤íŠ¸ ë£¨í”„**
  * ì½œ ìŠ¤íƒì´ ë¹„ì—ˆë‹¤ë©´, íƒœìŠ¤í¬ íì— ìˆëŠ” ì½œë°± í•¨ìˆ˜ë¥¼ ì²˜ë¦¬í•œë‹¤. 
* **íƒœìŠ¤í¬ í**
  * ì´ë²¤íŠ¸ ë£¨í”„ëŠ” í•˜ë‚˜ ì´ìƒì˜ íƒœìŠ¤í¬ íë¥¼ ê°–ëŠ”ë‹¤. 
  * íƒœìŠ¤í¬ íëŠ” **íƒœìŠ¤í¬ì˜ Set**ì´ë‹¤.
  * ì´ë²¤íŠ¸ ë£¨í”„ê°€ íì˜ ì²« ë²ˆì§¸ íƒœìŠ¤í¬ë¥¼ ê°€ì ¸ì˜¤ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, íƒœìŠ¤í¬ íì—ì„œ ì‹¤í–‰ ê°€ëŠ¥í•œ\(runnable\) ì²« ë²ˆì§¸ íƒœìŠ¤í¬ë¥¼ ê°€ì ¸ì˜¤ëŠ” ê²ƒì´ë‹¤. íƒœìŠ¤í¬ ì¤‘ì—ì„œ ê°€ì¥ ì˜¤ë˜ëœ íƒœìŠ¤í¬ë¥¼ ê°€ì ¸ì˜¨ë‹¤.

    > Task queues are **sets, not queues**, because step one of the event loop processing model **grabs the first runnable task from the chosen queue**, instead of dequeuing the first task.

### ğŸ“ Node.js í™˜ê²½ì˜ êµ¬ì¡°

![](https://i.imgur.com/FecAm36.png)

Node.js ëŠ” ë¹„ë™ê¸° IOë¥¼ ì§€ì›í•˜ê¸° ìœ„í•´ `libuv`ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•œë‹¤. ì´ libuvê°€ ì´ë²¤íŠ¸ ë£¨í”„ë¥¼ ì œê³µí•œë‹¤.

## ğŸ“•ì´ë²¤íŠ¸ ë£¨í”„

### ğŸ“ ì´ë²¤íŠ¸ ë£¨í”„ê°€ ì™œ í•„ìš”í• ê¹Œ?

ë¸Œë¼ìš°ì €ì™€ Node.jsì—ì„œ ê³µí†µìœ¼ë¡œ ì œê³µí•˜ëŠ” ê²ƒì´ `ì´ë²¤íŠ¸ ë£¨í”„`ì´ë‹¤. ìë°”ìŠ¤í¬ë¦½íŠ¸ëŠ” ì‹±ê¸€ ìŠ¤ë ˆë“œ ê¸°ë°˜ì˜ ì–¸ì–´ì§€ë§Œ, **ìë°”ìŠ¤í¬ë¦½íŠ¸ê°€ êµ¬ë™ë˜ëŠ” í™˜ê²½\(Node.js, ë¸Œë¼ìš°ì €\)ì€ ì—¬ëŸ¬ ìŠ¤ë ˆë“œê°€ ì‚¬ìš©**ëœë‹¤. **ì—¬ëŸ¬ ìŠ¤ë ˆë“œê°€ ì‚¬ìš©ë˜ëŠ” êµ¬ë™ í™˜ê²½ì´ ìë°”ìŠ¤í¬ë¦½íŠ¸ ì—”ì§„ê³¼ ì—°ë™í•˜ê¸° ìœ„í•´ ì‚¬ìš©ë˜ëŠ” ì¥ì¹˜ê°€ 'ì´ë²¤íŠ¸ ë£¨í”„'** ì´ë‹¤.

ì›¹ ì‚¬ì´íŠ¸ë‚˜ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ì½”ë“œëŠ” **ë©”ì¸ ìŠ¤ë ˆë“œ**ì—ì„œ ì‹¤í–‰ë˜ë©°, **ê°™ì€ ì´ë²¤íŠ¸ ë£¨í”„ë¥¼ ê³µìœ í•œë‹¤.**

### ğŸ“ ë©”ì¸ ìŠ¤ë ˆë“œì˜ ì—­í• 

**ë©”ì¸ ìŠ¤ë ˆë“œ**ëŠ” ì‚¬ì´íŠ¸ì˜ \(1\)**ì½”ë“œë¥¼ ì‹¤í–‰**ì‹œí‚¬ ë¿ë§Œ ì•„ë‹ˆë¼, \(2\)**ì´ë²¤íŠ¸ë“¤ì„ ë°›ê³  ì‹¤í–‰**ì‹œí‚¤ê±°ë‚˜, \(3\)**ì›¹ ì»¨í…ì¸ ë¥¼ ë Œë”ë§í•˜ê±°ë‚˜ í˜ì¸íŒ…** í•˜ëŠ” ì¼ë“¤ì„ í•œë‹¤.

ì¦‰, ì´ë²¤íŠ¸ ë£¨í”„ëŠ” ìŠ¤ë ˆë“œ ì•ˆì— ìˆëŠ” **ì½”ë“œë“¤ì„ ìŠ¤ì¼€ì¥´ë§í•˜ê³  ì‹¤í–‰ì‹œí‚¤ëŠ” ì—­í• **ì„ ë‹´ë‹¹í•œë‹¤.

### ğŸ“ ì´ë²¤íŠ¸ ë£¨í”„ì˜ ì¢…ë¥˜

ì´ë²¤íŠ¸ ë£¨í”„ëŠ” ì„¸ ê°€ì§€ ì¢…ë¥˜ê°€ ìˆë‹¤.

* **window event loop**
  * ê°™ì€ originì¸ ëª¨ë“  ìœˆë„ìš°ëŠ” ìœˆë„ìš° ì´ë²¤íŠ¸ ë£¨í”„ë¥¼ ê³µìœ í•œë‹¤.
  * ëª¨ë“  ìœˆë„ìš°ë“¤ì€ ë™ê¸°ì ìœ¼ë¡œ ì†Œí†µí•  ìˆ˜ ìˆê²Œ ëœë‹¤.
* **worker event loop**
  * window event loopì™€ëŠ” ë…ë¦½ì ìœ¼ë¡œ ì‹¤í–‰ëœë‹¤.
* **worklet event loop**

## ğŸ“• ë§ˆì´í¬ë¡œ íƒœìŠ¤í¬ì™€ ë§¤í¬ë¡œ íƒœìŠ¤í¬ \(microtask, macrotask\)

![](https://uploads.disquscdn.com/images/9466d8aa53fc5b3e63a92858a94bb429df02bbd20012b738f0461343beaa6f90.gif?w=600&h=272)

### ğŸ“ ë§ˆì´í¬ë¡œ íƒœìŠ¤í¬ vs ë§¤í¬ë¡œ íƒœìŠ¤í¬

**ë§ˆì´í¬ë¡œ íƒœìŠ¤í¬ë“¤ì€ ì‹¤í–‰í•˜ë©´ì„œ ìƒˆë¡œìš´ ë§ˆì´í¬ë¡œ íƒœìŠ¤í¬ë¥¼ íì— ì¶”ê°€í•  ìˆ˜ë„ ìˆë‹¤. ìƒˆë¡­ê²Œ ì¶”ê°€ëœ ë§ˆì´í¬ë¡œ íƒœìŠ¤í¬ë„ íê°€ ë¹Œ ë•Œê¹Œì§€ ê³„ì†í•´ì„œ ì‹¤í–‰ëœë‹¤.**

ë°˜ëŒ€ë¡œ, ì´ë²¤íŠ¸ ë£¨í”„ëŠ” ë§¤í¬ë¡œ íƒœìŠ¤í¬ íì— ìˆëŠ” ê²ƒì„ ì‹¤í–‰ì‹œí‚¤ê¸° ì‹œì‘í•  ë•Œ ìˆëŠ” ë§¤í¬ë¡œ íƒœìŠ¤í¬ë§Œ ì‹¤í–‰ì‹œí‚¨ë‹¤. **ë§¤í¬ë¡œ íƒœìŠ¤í¬ê°€ ì¶”ê°€í•œ ë§¤í¬ë¡œ íƒœìŠ¤í¬ëŠ” ë‹¤ìŒ ì´ë²¤íŠ¸ ë£¨í”„ê°€ ì‹¤í–‰ë  ë•Œê¹Œì§€ ì‹¤í–‰ë˜ì§€ ì•ŠëŠ”ë‹¤.**

### ğŸ“ ë§ˆì´í¬ë¡œ íƒœìŠ¤í¬ í & ë§¤í¬ë¡œ íƒœìŠ¤í¬ í

íƒœìŠ¤í¬ íëŠ” êµ¬ì²´ì ìœ¼ë¡œ **ë§ˆì´í¬ë¡œ íƒœìŠ¤í¬í\(Event Queue\)** ì™€ **ë§¤í¬ë¡œ íƒœìŠ¤í¬í\(Job Queue\)** ë¡œ ë‚˜ë‰˜ì–´ì§„ë‹¤.

APIì— ë”°ë¼ ë§ˆì´í¬ë¡œ íƒœìŠ¤í¬ íë¥¼ ì‚¬ìš©í•˜ê±°ë‚˜, ë§¤í¬ë¡œ íƒœìŠ¤í¬ íë¥¼ ì‚¬ìš©í•œë‹¤.

> **macrotasks**: requestAnimationFrame, I/O, UI rendering, setTimeout, setInterval, setImmediate **microtasks**: process.nextTick, Promises, queueMicrotask\(f\), MutationObserver

## ğŸ“• ì´ë²¤íŠ¸ ë£¨í”„ì˜ ë™ì‘ ë°©ì‹

![](https://i.imgur.com/sEf4Opl.png)

ì´ë²¤íŠ¸ ë£¨í”„ëŠ” ë‹¤ìŒì„ ë°˜ë³µí•œë‹¤.

1. **ë§¤í¬ë¡œ íƒœìŠ¤í¬** íì—ì„œ _ê°€ì¥ ì˜¤ë˜ëœ íƒœìŠ¤í¬_ ë¥¼ êº¼ë‚´ì„œ ì‹¤í–‰ì‹œí‚¨ë‹¤. 
2. **ë§ˆì´í¬ë¡œ íƒœìŠ¤í¬** íì— ìˆëŠ” ëª¨ë“  íƒœìŠ¤í¬ë¥¼ ì‹¤í–‰ì‹œí‚¨ë‹¤.
3. **ë Œë”ë§** ì‘ì—…ì„ ì‹¤í–‰í•œë‹¤.
4. ë§¤í¬ë¡œ íƒœìŠ¤í¬ íì— ìƒˆë¡œìš´ ë§¤í¬ë¡œ íƒœìŠ¤í¬ê°€ ë‚˜íƒ€ë‚  ë•Œê¹Œì§€ **ëŒ€ê¸°**í•œë‹¤. 
5. 1ë²ˆìœ¼ë¡œ ëŒì•„ê°„ë‹¤.

## ğŸ“• ì˜ˆì‹œ

![](https://uploads.disquscdn.com/images/fb98edb750d6839fbc9958548f3b2a97e26f30fa5f529b8a9fed296c7a71a2d8.gif?w=800&h=405)

ë‹¤ìŒ ì½”ë“œë¥¼ ë³´ê³  ê²°ê³¼ë¥¼ ì˜ˆìƒí•´ë³´ì.

```javascript
console.log('script start'); // A

setTimeout(function () { // B
  console.log('setTimeout');
}, 0);

Promise.resolve() 
  .then(function () { // C
    console.log('promise1');
  })
  .then(function () { // D
    console.log('promise2');
  });

console.log('script end'); // E
```

```text
script start
script end
promise1
promise2
setTimeout
```

ì½”ë“œëŠ” ìœ„ì—ì„œë¶€í„° ì°¨ë¡€ë¡œ ì‹¤í–‰ëœë‹¤. [ì´ê³³](https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/)ì—ì„œ ì‹¤í–‰ë˜ëŠ” ê³¼ì •ì„ step-by-stepìœ¼ë¡œ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

1. ì½œ ìŠ¤íƒì—ëŠ” ì „ì—­ ì‹¤í–‰ ê°ì²´ê°€ ìˆê³ , 'ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰'ì´ë¼ëŠ” íƒœìŠ¤í¬ê°€ ë§¤í¬ë¡œ íƒœìŠ¤í¬ íì— ë“¤ì–´ìˆë‹¤. 
2. ì´ë²¤íŠ¸ ë£¨í”„ëŠ” ë§¤í¬ë¡œ íƒœìŠ¤í¬ íì— ìˆëŠ” 'ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰' íƒœìŠ¤í¬ë¥¼ ì‹¤í–‰í•œë‹¤. 
3. Aì— ë„ë‹¬í•˜ë©´, 'script start'ê°€ ì¶œë ¥ëœë‹¤. 
4. Bì— ë„ë‹¬í•˜ë©´, setTimeout web apiê°€ íƒ€ì´ë¨¸ë¥¼ ì‹¤í–‰ì‹œí‚¤ê³ , íƒ€ì´ë¨¸ê°€ ì¢…ë£Œë˜ë©´ ì½œë°± í•¨ìˆ˜ê°€ ë§¤í¬ë¡œ íƒœìŠ¤í¬ íì— ë“¤ì–´ê°„ë‹¤. 
5. Cì— ë„ë‹¬í•˜ë©´, ì½œë°± í•¨ìˆ˜ê°€ ë§ˆì´í¬ë¡œ íƒœìŠ¤í¬ íì— ë“¤ì–´ê°„ë‹¤. 
6. Eì— ë„ë‹¬í•˜ë©´, 'script end'ê°€ ì¶œë ¥ëœë‹¤. 
7. ì½œ ìŠ¤íƒì´ ë¹„ì—ˆìœ¼ë¯€ë¡œ, ì´ë²¤íŠ¸ ë£¨í”„ëŠ” ë§ˆì´í¬ë¡œ íƒœìŠ¤í¬ íì— ìˆëŠ” í”„ë¼ë¯¸ìŠ¤ ì½œë°± í•¨ìˆ˜ë¥¼ ì‹¤í–‰ì‹œí‚¨ë‹¤. 
8. 'promise 1'ì´ ì¶œë ¥ëœë‹¤. 
9. Promise.then ë©”ì„œë“œëŠ” D ì½œë°± í•¨ìˆ˜ë¥¼ ë§ˆì´í¬ë¡œ íƒœìŠ¤í¬ íì— ë“±ë¡í•œë‹¤. 
10. ì´ë²¤íŠ¸ ë£¨í”„ëŠ” ë‹¤ìŒ ë§ˆì´í¬ë¡œ íƒœìŠ¤í¬ì¸ D ì½œë°± í•¨ìˆ˜ê°€ ì‹¤í–‰ì‹œí‚¨ë‹¤. 11. 'promise 2'ê°€ ì¶œë ¥ëœë‹¤. 
11. ë Œë”ë§í•  ê²ƒì´ ìˆìœ¼ë©´, ë¸Œë¼ìš°ì €ëŠ” ë Œë”ë§ì„ í•œë‹¤. 
12. ë§¤í¬ë¡œ íƒœìŠ¤í¬ íì— ìˆëŠ” setTimeout ì½œë°±í•¨ìˆ˜ë¥¼ ì‹¤í–‰ì‹œí‚¨ë‹¤. 
13. 'setTimeout'ì´ ì¶œë ¥ëœë‹¤.

## ì°¸ê³ 

* [ìë°”ìŠ¤í¬ë¦½íŠ¸ì™€ ì´ë²¤íŠ¸ ë£¨í”„ - TOAST](https://meetup.toast.com/posts/89)
* [JavaScript Event Loop Explained](https://medium.com/front-end-weekly/javascript-event-loop-explained-4cd26af121d4)
* [The JavaScript Event Loop: Explained](https://blog.carbonfive.com/the-javascript-event-loop-explained)
* [html spec - event loops](https://html.spec.whatwg.org/multipage/webappapis.html#event-loops)
* [ë§ˆì´í¬ë¡œíƒœìŠ¤í¬ í - ko.javascript](https://ko.javascript.info/microtask-queue)
* [Difference between microtask and macrotask within an event loop context - stackoverflow](https://stackoverflow.com/questions/25915634/difference-between-microtask-and-macrotask-within-an-event-loop-context)
* [In depth: Microtasks and the JavaScript runtime environment - MDN](https://developer.mozilla.org/en-US/docs/Web/API/HTML_DOM_API/Microtask_guide/In_depth)
* [Letâ€™s spin the event loop](https://medium.com/javascript-in-plain-english/lets-spin-the-event-loop-by-ashish-mishra-8ec4d1412376)
* [Tasks, microtasks, queues and schedules](https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/)
* [ì´ë²¤íŠ¸ ë£¨í”„ì™€ ë§¤í¬ë¡œÂ·ë§ˆì´í¬ë¡œíƒœìŠ¤í¬ - ko.javascript](https://ko.javascript.info/event-loop)

